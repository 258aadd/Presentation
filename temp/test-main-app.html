<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»åº”ç”¨æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¸»åº”ç”¨åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>
        <button onclick="testDBConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
        <div id="db-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æ•°æ®æŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testDataQuery()">æŸ¥è¯¢æ‰€æœ‰æ•°æ®</button>
        <div id="query-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>å­˜å‚¨ä¿¡æ¯æµ‹è¯•</h3>
        <button onclick="testStorageInfo()">è·å–å­˜å‚¨ä¿¡æ¯</button>
        <div id="storage-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ä¸»åº”ç”¨é“¾æ¥</h3>
        <button onclick="window.open('index.html', '_blank')">æ‰“å¼€ä¸»åº”ç”¨</button>
        <button onclick="window.open('debug.html', '_blank')">æ‰“å¼€è°ƒè¯•é¡µé¢</button>
    </div>

    <script>
        // å¼•å…¥ä¸»åº”ç”¨çš„è„šæœ¬ï¼ˆä½†ä¸æ‰§è¡ŒDOMContentLoadedï¼‰
        let db = null;
        const DB_NAME = 'FileManagerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';

        // åˆå§‹åŒ–æ•°æ®åº“
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB æ‰“å¼€å¤±è´¥:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB è¿æ¥æˆåŠŸ');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB å‡çº§ä¸­...');
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('userId', 'userId', { unique: false });
                        store.createIndex('title', 'title', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('å¯¹è±¡å­˜å‚¨åˆ›å»ºæˆåŠŸ');
                    }
                };
            });
        }

        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDBConnection() {
            const resultDiv = document.getElementById('db-result');
            try {
                await initDB();
                resultDiv.innerHTML = '<div class="success">âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•æ•°æ®æŸ¥è¯¢
        async function testDataQuery() {
            const resultDiv = document.getElementById('query-result');
            
            if (!db) {
                resultDiv.innerHTML = '<div class="error">âŒ æ•°æ®åº“æœªè¿æ¥ï¼Œè¯·å…ˆæµ‹è¯•æ•°æ®åº“è¿æ¥</div>';
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const results = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (results.length === 0) {
                    resultDiv.innerHTML = '<div class="error">ğŸ“­ æ•°æ®åº“ä¸­æš‚æ— æ•°æ®</div>';
                } else {
                    const summary = results.map(item => ({
                        id: item.id,
                        userId: item.userId,
                        title: item.title,
                        timestamp: item.timestamp,
                        videoSize: (new Blob([item.video]).size / 1024 / 1024).toFixed(2) + ' MB',
                        markdownSize: (new Blob([item.markdown]).size / 1024).toFixed(2) + ' KB'
                    }));
                    
                    resultDiv.innerHTML = `
                        <div class="success">âœ… æ‰¾åˆ° ${results.length} æ¡è®°å½•</div>
                        <pre>${JSON.stringify(summary, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•å­˜å‚¨ä¿¡æ¯
        async function testStorageInfo() {
            const resultDiv = document.getElementById('storage-result');
            
            if (!db) {
                resultDiv.innerHTML = '<div class="error">âŒ æ•°æ®åº“æœªè¿æ¥ï¼Œè¯·å…ˆæµ‹è¯•æ•°æ®åº“è¿æ¥</div>';
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const results = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                let totalSize = 0;
                const userInfo = {};
                
                results.forEach(item => {
                    const itemSize = new Blob([JSON.stringify(item)]).size;
                    totalSize += itemSize;
                    
                    if (!userInfo[item.userId]) {
                        userInfo[item.userId] = 0;
                    }
                    userInfo[item.userId]++;
                });

                const storageInfo = {
                    totalSize: totalSize,
                    totalSizeMB: (totalSize / 1024 / 1024).toFixed(2),
                    itemCount: results.length,
                    userCount: Object.keys(userInfo).length,
                    userInfo: userInfo
                };

                resultDiv.innerHTML = `
                    <div class="success">âœ… å­˜å‚¨ä¿¡æ¯è·å–æˆåŠŸ</div>
                    <pre>${JSON.stringify(storageInfo, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è·å–å­˜å‚¨ä¿¡æ¯å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•æ•°æ®åº“è¿æ¥
        window.onload = function() {
            testDBConnection();
        };
    </script>
</body>
</html>
