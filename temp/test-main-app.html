<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主应用测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔧 主应用功能测试</h1>
    
    <div class="test-section">
        <h3>数据库连接测试</h3>
        <button onclick="testDBConnection()">测试数据库连接</button>
        <div id="db-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>数据查询测试</h3>
        <button onclick="testDataQuery()">查询所有数据</button>
        <div id="query-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>存储信息测试</h3>
        <button onclick="testStorageInfo()">获取存储信息</button>
        <div id="storage-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>主应用链接</h3>
        <button onclick="window.open('index.html', '_blank')">打开主应用</button>
        <button onclick="window.open('debug.html', '_blank')">打开调试页面</button>
    </div>

    <script>
        // 引入主应用的脚本（但不执行DOMContentLoaded）
        let db = null;
        const DB_NAME = 'FileManagerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';

        // 初始化数据库
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB 打开失败:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB 连接成功');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB 升级中...');
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('userId', 'userId', { unique: false });
                        store.createIndex('title', 'title', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('对象存储创建成功');
                    }
                };
            });
        }

        // 测试数据库连接
        async function testDBConnection() {
            const resultDiv = document.getElementById('db-result');
            try {
                await initDB();
                resultDiv.innerHTML = '<div class="success">✅ 数据库连接成功！</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 数据库连接失败: ${error.message}</div>`;
            }
        }

        // 测试数据查询
        async function testDataQuery() {
            const resultDiv = document.getElementById('query-result');
            
            if (!db) {
                resultDiv.innerHTML = '<div class="error">❌ 数据库未连接，请先测试数据库连接</div>';
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const results = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                if (results.length === 0) {
                    resultDiv.innerHTML = '<div class="error">📭 数据库中暂无数据</div>';
                } else {
                    const summary = results.map(item => ({
                        id: item.id,
                        userId: item.userId,
                        title: item.title,
                        timestamp: item.timestamp,
                        videoSize: (new Blob([item.video]).size / 1024 / 1024).toFixed(2) + ' MB',
                        markdownSize: (new Blob([item.markdown]).size / 1024).toFixed(2) + ' KB'
                    }));
                    
                    resultDiv.innerHTML = `
                        <div class="success">✅ 找到 ${results.length} 条记录</div>
                        <pre>${JSON.stringify(summary, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 查询失败: ${error.message}</div>`;
            }
        }

        // 测试存储信息
        async function testStorageInfo() {
            const resultDiv = document.getElementById('storage-result');
            
            if (!db) {
                resultDiv.innerHTML = '<div class="error">❌ 数据库未连接，请先测试数据库连接</div>';
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                const results = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                let totalSize = 0;
                const userInfo = {};
                
                results.forEach(item => {
                    const itemSize = new Blob([JSON.stringify(item)]).size;
                    totalSize += itemSize;
                    
                    if (!userInfo[item.userId]) {
                        userInfo[item.userId] = 0;
                    }
                    userInfo[item.userId]++;
                });

                const storageInfo = {
                    totalSize: totalSize,
                    totalSizeMB: (totalSize / 1024 / 1024).toFixed(2),
                    itemCount: results.length,
                    userCount: Object.keys(userInfo).length,
                    userInfo: userInfo
                };

                resultDiv.innerHTML = `
                    <div class="success">✅ 存储信息获取成功</div>
                    <pre>${JSON.stringify(storageInfo, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 获取存储信息失败: ${error.message}</div>`;
            }
        }

        // 页面加载时自动测试数据库连接
        window.onload = function() {
            testDBConnection();
        };
    </script>
</body>
</html>
