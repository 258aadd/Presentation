<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试页面 - 测试系统v1.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-panel h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 测试系统v1.0 - 调试页面</h1>
    
    <div class="debug-panel">
        <h3>系统检测</h3>
        <div id="system-status"></div>
        <button onclick="checkSystem()">检查系统状态</button>
    </div>

    <div class="debug-panel">
        <h3>localStorage 测试</h3>
        <div id="storage-status"></div>
        <button onclick="testStorage()">测试存储功能</button>
        <button onclick="clearStorage()">清除所有数据</button>
        <button onclick="showStorageData()">显示存储数据</button>
    </div>

    <div class="debug-panel">
        <h3>文件上传测试</h3>
        <form id="test-upload-form">
            <div style="margin: 10px 0;">
                <label>用户ID: <input type="text" id="test-user-id" value="test-user"></label>
            </div>
            <div style="margin: 10px 0;">
                <label>标题: <input type="text" id="test-title" value="测试标题"></label>
            </div>
            <div style="margin: 10px 0;">
                <label>视频文件: <input type="file" id="test-video" accept="video/*"></label>
            </div>
            <div style="margin: 10px 0;">
                <label>Markdown文件: <input type="file" id="test-markdown" accept=".md,.markdown"></label>
            </div>
            <button type="submit">测试上传</button>
        </form>
        <div id="upload-status"></div>
    </div>

    <div class="debug-panel">
        <h3>控制台日志</h3>
        <div id="console-log"></div>
        <button onclick="clearLog()">清除日志</button>
    </div>

    <div class="debug-panel">
        <h3>快速操作</h3>
        <button onclick="window.open('index.html', '_blank')">打开主应用</button>
        <button onclick="createTestFiles()">创建测试文件</button>
    </div>

    <script>
        let logs = [];

        // 重写console.log来捕获日志
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', args.join(' '));
        };

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ type, message, timestamp });
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = logs.slice(-20).map(log => 
                `<div style="margin:2px 0; font-size:12px;">
                    <span style="color:#666;">[${log.timestamp}]</span> 
                    <span style="color:${log.type === 'ERROR' ? 'red' : 'blue'};">${log.type}:</span> 
                    ${log.message}
                </div>`
            ).join('');
        }

        function clearLog() {
            logs = [];
            updateLogDisplay();
        }

        function checkSystem() {
            const statusDiv = document.getElementById('system-status');
            let html = '';

            // 检查浏览器支持
            html += `<div class="status info">浏览器: ${navigator.userAgent}</div>`;
            
            // 检查IndexedDB支持
            if (window.indexedDB) {
                html += '<div class="status success">✓ IndexedDB 支持正常</div>';
            } else {
                html += '<div class="status error">✗ IndexedDB 不支持</div>';
            }
            
            // 检查localStorage支持
            if (typeof(Storage) !== "undefined") {
                html += '<div class="status success">✓ localStorage 支持正常</div>';
            } else {
                html += '<div class="status error">✗ localStorage 不支持</div>';
            }

            // 检查File API支持
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                html += '<div class="status success">✓ File API 支持正常</div>';
            } else {
                html += '<div class="status error">✗ File API 不支持</div>';
            }

            statusDiv.innerHTML = html;
        }

        function testStorage() {
            const statusDiv = document.getElementById('storage-status');
            try {
                // 测试存储
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem('test-storage', JSON.stringify(testData));
                
                // 测试读取
                const retrieved = JSON.parse(localStorage.getItem('test-storage'));
                
                if (retrieved && retrieved.test === 'data') {
                    statusDiv.innerHTML = '<div class="status success">✓ localStorage 读写正常</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">✗ localStorage 数据不一致</div>';
                }
                
                localStorage.removeItem('test-storage');
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">✗ localStorage 错误: ${error.message}</div>`;
            }
        }

        async function clearStorage() {
            if (confirm('确定要清除所有存储数据吗？')) {
                try {
                    // 清除localStorage
                    localStorage.removeItem('fileManagerData');
                    
                    // 清除IndexedDB测试数据
                    if (testDB) {
                        const transaction = testDB.transaction([TEST_STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(TEST_STORE_NAME);
                        await new Promise((resolve, reject) => {
                            const request = store.clear();
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject(request.error);
                        });
                    }
                    
                    document.getElementById('storage-status').innerHTML = '<div class="status info">存储数据已清除</div>';
                } catch (error) {
                    document.getElementById('storage-status').innerHTML = `<div class="status error">清除失败: ${error.message}</div>`;
                }
            }
        }

        async function showStorageData() {
            const statusDiv = document.getElementById('storage-status');
            
            try {
                let html = '';
                
                // 显示localStorage数据
                const localData = localStorage.getItem('fileManagerData');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    const size = new Blob([localData]).size;
                    html += `<div class="status info">localStorage数据大小: ${(size / 1024).toFixed(2)} KB</div>`;
                } else {
                    html += '<div class="status info">localStorage: 暂无数据</div>';
                }
                
                // 显示IndexedDB数据
                if (testDB) {
                    const transaction = testDB.transaction([TEST_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(TEST_STORE_NAME);
                    
                    const results = await new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    let totalSize = 0;
                    results.forEach(item => {
                        totalSize += new Blob([JSON.stringify(item)]).size;
                    });
                    
                    html += `<div class="status info">IndexedDB数据: ${results.length} 条记录, ${(totalSize / 1024 / 1024).toFixed(2)} MB</div>`;
                    
                    if (results.length > 0) {
                        html += '<pre>' + JSON.stringify(results.map(item => ({
                            id: item.id,
                            userId: item.userId,
                            title: item.title,
                            timestamp: item.timestamp,
                            videoSize: (new Blob([item.video]).size / 1024 / 1024).toFixed(2) + ' MB',
                            markdownSize: (new Blob([item.markdown]).size / 1024).toFixed(2) + ' KB'
                        })), null, 2) + '</pre>';
                    }
                } else {
                    html += '<div class="status info">IndexedDB: 未初始化</div>';
                }
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">获取数据失败: ${error.message}</div>`;
            }
        }

        function createTestFiles() {
            // 创建测试Markdown文件
            const markdownContent = `# 测试文档

这是一个测试用的Markdown文档。

## 功能列表

- 支持标题
- 支持列表
- 支持**粗体**和*斜体*
- 支持\`代码\`

## 代码示例

\`\`\`javascript
console.log("Hello World!");
\`\`\`

> 这是一个引用块

测试完成！`;

            const blob = new Blob([markdownContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test.md';
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('upload-status').innerHTML = '<div class="status info">测试Markdown文件已下载，请选择该文件进行测试</div>';
        }

        // 测试上传表单
        document.getElementById('test-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const statusDiv = document.getElementById('upload-status');
            const userId = document.getElementById('test-user-id').value;
            const title = document.getElementById('test-title').value;
            const videoFile = document.getElementById('test-video').files[0];
            const markdownFile = document.getElementById('test-markdown').files[0];

            if (!userId || !title || !videoFile || !markdownFile) {
                statusDiv.innerHTML = '<div class="status error">请填写所有字段并选择文件</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">开始测试上传...</div>';

            try {
                // 模拟主应用的上传逻辑
                console.log('测试开始...');
                
                // 读取文件
                const videoData = await readFileAsDataURL(videoFile);
                const markdownContent = await readFileAsText(markdownFile);
                
                console.log('文件读取完成');
                
                // 保存数据
                const success = saveData(userId, title, videoData, markdownContent);
                
                if (success) {
                    statusDiv.innerHTML = '<div class="status success">✓ 测试上传成功！</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">✗ 测试上传失败</div>';
                }
            } catch (error) {
                console.error('测试上传错误:', error);
                statusDiv.innerHTML = `<div class="status error">✗ 测试错误: ${error.message}</div>`;
            }
        });

        // IndexedDB 配置和初始化（使用与主应用相同的数据库）
        let testDB = null;
        const TEST_DB_NAME = 'FileManagerDB';
        const TEST_DB_VERSION = 1;
        const TEST_STORE_NAME = 'files';

        function initTestDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(TEST_DB_NAME, TEST_DB_VERSION);
                
                request.onerror = () => {
                    console.error('测试数据库打开失败:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    testDB = request.result;
                    console.log('测试数据库连接成功');
                    resolve(testDB);
                };
                
                request.onupgradeneeded = (event) => {
                    testDB = event.target.result;
                    console.log('测试数据库升级中...');
                    
                    if (!testDB.objectStoreNames.contains(TEST_STORE_NAME)) {
                        const store = testDB.createObjectStore(TEST_STORE_NAME, { keyPath: 'id' });
                        store.createIndex('userId', 'userId', { unique: false });
                        store.createIndex('title', 'title', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('测试对象存储创建成功');
                    }
                };
            });
        }

        // 复制主应用的函数（IndexedDB版本）
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                console.log('开始读取视频文件:', file.name, file.type, (file.size / 1024 / 1024).toFixed(2) + ' MB');
                
                if (!file) {
                    reject(new Error('没有选择文件'));
                    return;
                }
                
                if (file.size > 50 * 1024 * 1024) { // 50MB限制
                    reject(new Error('视频文件过大，请选择小于50MB的文件'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = e => {
                    console.log('视频文件读取成功');
                    resolve(e.target.result);
                };
                reader.onerror = () => {
                    console.error('视频文件读取失败');
                    reject(new Error('视频文件读取失败'));
                };
                reader.readAsDataURL(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                console.log('开始读取Markdown文件:', file.name, file.type, (file.size / 1024).toFixed(2) + ' KB');
                
                if (!file) {
                    reject(new Error('没有选择文件'));
                    return;
                }
                
                if (file.size > 1024 * 1024) { // 1MB限制
                    reject(new Error('Markdown文件过大，请选择小于1MB的文件'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = e => {
                    console.log('Markdown文件读取成功');
                    resolve(e.target.result);
                };
                reader.onerror = () => {
                    console.error('Markdown文件读取失败');
                    reject(new Error('Markdown文件读取失败'));
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function saveData(userId, title, videoData, markdownContent) {
            try {
                console.log('开始保存数据到IndexedDB...', { userId, title });
                
                if (!testDB) {
                    throw new Error('测试数据库未初始化');
                }
                
                // 创建唯一ID
                const id = `${userId}:${title}`;
                
                // 准备数据对象
                const dataObject = {
                    id: id,
                    userId: userId,
                    title: title,
                    video: videoData,
                    markdown: markdownContent,
                    timestamp: new Date().toISOString()
                };
                
                // 计算数据大小
                const dataSize = new Blob([JSON.stringify(dataObject)]).size;
                const dataSizeMB = (dataSize / 1024 / 1024).toFixed(2);
                console.log('数据大小:', dataSizeMB + ' MB');
                
                // 开始事务
                const transaction = testDB.transaction([TEST_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(TEST_STORE_NAME);
                
                return new Promise((resolve, reject) => {
                    const request = store.put(dataObject);
                    
                    request.onsuccess = () => {
                        console.log('数据保存成功，大小:', dataSizeMB + ' MB');
                        resolve(true);
                    };
                    
                    request.onerror = () => {
                        console.error('数据保存失败:', request.error);
                        reject(request.error);
                    };
                    
                    transaction.oncomplete = () => {
                        console.log('事务完成');
                    };
                    
                    transaction.onerror = () => {
                        console.error('事务失败:', transaction.error);
                        reject(transaction.error);
                    };
                });
                
            } catch (error) {
                console.error('保存数据失败:', error);
                alert('保存失败: ' + error.message);
                return false;
            }
        }

        // 页面加载完成后自动检查系统
        window.onload = async function() {
            checkSystem();
            testStorage();
            
            // 初始化测试数据库
            try {
                await initTestDB();
                console.log('测试数据库初始化完成');
            } catch (error) {
                console.error('测试数据库初始化失败:', error);
                addLog('ERROR', '测试数据库初始化失败: ' + error.message);
            }
        };
    </script>
</body>
</html>
