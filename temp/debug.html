<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - æµ‹è¯•ç³»ç»Ÿv1.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-panel h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æµ‹è¯•ç³»ç»Ÿv1.0 - è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-panel">
        <h3>ç³»ç»Ÿæ£€æµ‹</h3>
        <div id="system-status"></div>
        <button onclick="checkSystem()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
    </div>

    <div class="debug-panel">
        <h3>localStorage æµ‹è¯•</h3>
        <div id="storage-status"></div>
        <button onclick="testStorage()">æµ‹è¯•å­˜å‚¨åŠŸèƒ½</button>
        <button onclick="clearStorage()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <button onclick="showStorageData()">æ˜¾ç¤ºå­˜å‚¨æ•°æ®</button>
    </div>

    <div class="debug-panel">
        <h3>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
        <form id="test-upload-form">
            <div style="margin: 10px 0;">
                <label>ç”¨æˆ·ID: <input type="text" id="test-user-id" value="test-user"></label>
            </div>
            <div style="margin: 10px 0;">
                <label>æ ‡é¢˜: <input type="text" id="test-title" value="æµ‹è¯•æ ‡é¢˜"></label>
            </div>
            <div style="margin: 10px 0;">
                <label>è§†é¢‘æ–‡ä»¶: <input type="file" id="test-video" accept="video/*"></label>
            </div>
            <div style="margin: 10px 0;">
                <label>Markdownæ–‡ä»¶: <input type="file" id="test-markdown" accept=".md,.markdown"></label>
            </div>
            <button type="submit">æµ‹è¯•ä¸Šä¼ </button>
        </form>
        <div id="upload-status"></div>
    </div>

    <div class="debug-panel">
        <h3>æ§åˆ¶å°æ—¥å¿—</h3>
        <div id="console-log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div class="debug-panel">
        <h3>å¿«é€Ÿæ“ä½œ</h3>
        <button onclick="window.open('index.html', '_blank')">æ‰“å¼€ä¸»åº”ç”¨</button>
        <button onclick="createTestFiles()">åˆ›å»ºæµ‹è¯•æ–‡ä»¶</button>
    </div>

    <script>
        let logs = [];

        // é‡å†™console.logæ¥æ•è·æ—¥å¿—
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', args.join(' '));
        };

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ type, message, timestamp });
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = logs.slice(-20).map(log => 
                `<div style="margin:2px 0; font-size:12px;">
                    <span style="color:#666;">[${log.timestamp}]</span> 
                    <span style="color:${log.type === 'ERROR' ? 'red' : 'blue'};">${log.type}:</span> 
                    ${log.message}
                </div>`
            ).join('');
        }

        function clearLog() {
            logs = [];
            updateLogDisplay();
        }

        function checkSystem() {
            const statusDiv = document.getElementById('system-status');
            let html = '';

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            html += `<div class="status info">æµè§ˆå™¨: ${navigator.userAgent}</div>`;
            
            // æ£€æŸ¥IndexedDBæ”¯æŒ
            if (window.indexedDB) {
                html += '<div class="status success">âœ“ IndexedDB æ”¯æŒæ­£å¸¸</div>';
            } else {
                html += '<div class="status error">âœ— IndexedDB ä¸æ”¯æŒ</div>';
            }
            
            // æ£€æŸ¥localStorageæ”¯æŒ
            if (typeof(Storage) !== "undefined") {
                html += '<div class="status success">âœ“ localStorage æ”¯æŒæ­£å¸¸</div>';
            } else {
                html += '<div class="status error">âœ— localStorage ä¸æ”¯æŒ</div>';
            }

            // æ£€æŸ¥File APIæ”¯æŒ
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                html += '<div class="status success">âœ“ File API æ”¯æŒæ­£å¸¸</div>';
            } else {
                html += '<div class="status error">âœ— File API ä¸æ”¯æŒ</div>';
            }

            statusDiv.innerHTML = html;
        }

        function testStorage() {
            const statusDiv = document.getElementById('storage-status');
            try {
                // æµ‹è¯•å­˜å‚¨
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem('test-storage', JSON.stringify(testData));
                
                // æµ‹è¯•è¯»å–
                const retrieved = JSON.parse(localStorage.getItem('test-storage'));
                
                if (retrieved && retrieved.test === 'data') {
                    statusDiv.innerHTML = '<div class="status success">âœ“ localStorage è¯»å†™æ­£å¸¸</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">âœ— localStorage æ•°æ®ä¸ä¸€è‡´</div>';
                }
                
                localStorage.removeItem('test-storage');
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âœ— localStorage é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®å—ï¼Ÿ')) {
                try {
                    // æ¸…é™¤localStorage
                    localStorage.removeItem('fileManagerData');
                    
                    // æ¸…é™¤IndexedDBæµ‹è¯•æ•°æ®
                    if (testDB) {
                        const transaction = testDB.transaction([TEST_STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(TEST_STORE_NAME);
                        await new Promise((resolve, reject) => {
                            const request = store.clear();
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject(request.error);
                        });
                    }
                    
                    document.getElementById('storage-status').innerHTML = '<div class="status info">å­˜å‚¨æ•°æ®å·²æ¸…é™¤</div>';
                } catch (error) {
                    document.getElementById('storage-status').innerHTML = `<div class="status error">æ¸…é™¤å¤±è´¥: ${error.message}</div>`;
                }
            }
        }

        async function showStorageData() {
            const statusDiv = document.getElementById('storage-status');
            
            try {
                let html = '';
                
                // æ˜¾ç¤ºlocalStorageæ•°æ®
                const localData = localStorage.getItem('fileManagerData');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    const size = new Blob([localData]).size;
                    html += `<div class="status info">localStorageæ•°æ®å¤§å°: ${(size / 1024).toFixed(2)} KB</div>`;
                } else {
                    html += '<div class="status info">localStorage: æš‚æ— æ•°æ®</div>';
                }
                
                // æ˜¾ç¤ºIndexedDBæ•°æ®
                if (testDB) {
                    const transaction = testDB.transaction([TEST_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(TEST_STORE_NAME);
                    
                    const results = await new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    let totalSize = 0;
                    results.forEach(item => {
                        totalSize += new Blob([JSON.stringify(item)]).size;
                    });
                    
                    html += `<div class="status info">IndexedDBæ•°æ®: ${results.length} æ¡è®°å½•, ${(totalSize / 1024 / 1024).toFixed(2)} MB</div>`;
                    
                    if (results.length > 0) {
                        html += '<pre>' + JSON.stringify(results.map(item => ({
                            id: item.id,
                            userId: item.userId,
                            title: item.title,
                            timestamp: item.timestamp,
                            videoSize: (new Blob([item.video]).size / 1024 / 1024).toFixed(2) + ' MB',
                            markdownSize: (new Blob([item.markdown]).size / 1024).toFixed(2) + ' KB'
                        })), null, 2) + '</pre>';
                    }
                } else {
                    html += '<div class="status info">IndexedDB: æœªåˆå§‹åŒ–</div>';
                }
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">è·å–æ•°æ®å¤±è´¥: ${error.message}</div>`;
            }
        }

        function createTestFiles() {
            // åˆ›å»ºæµ‹è¯•Markdownæ–‡ä»¶
            const markdownContent = `# æµ‹è¯•æ–‡æ¡£

è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨çš„Markdownæ–‡æ¡£ã€‚

## åŠŸèƒ½åˆ—è¡¨

- æ”¯æŒæ ‡é¢˜
- æ”¯æŒåˆ—è¡¨
- æ”¯æŒ**ç²—ä½“**å’Œ*æ–œä½“*
- æ”¯æŒ\`ä»£ç \`

## ä»£ç ç¤ºä¾‹

\`\`\`javascript
console.log("Hello World!");
\`\`\`

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—

æµ‹è¯•å®Œæˆï¼`;

            const blob = new Blob([markdownContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test.md';
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('upload-status').innerHTML = '<div class="status info">æµ‹è¯•Markdownæ–‡ä»¶å·²ä¸‹è½½ï¼Œè¯·é€‰æ‹©è¯¥æ–‡ä»¶è¿›è¡Œæµ‹è¯•</div>';
        }

        // æµ‹è¯•ä¸Šä¼ è¡¨å•
        document.getElementById('test-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const statusDiv = document.getElementById('upload-status');
            const userId = document.getElementById('test-user-id').value;
            const title = document.getElementById('test-title').value;
            const videoFile = document.getElementById('test-video').files[0];
            const markdownFile = document.getElementById('test-markdown').files[0];

            if (!userId || !title || !videoFile || !markdownFile) {
                statusDiv.innerHTML = '<div class="status error">è¯·å¡«å†™æ‰€æœ‰å­—æ®µå¹¶é€‰æ‹©æ–‡ä»¶</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">å¼€å§‹æµ‹è¯•ä¸Šä¼ ...</div>';

            try {
                // æ¨¡æ‹Ÿä¸»åº”ç”¨çš„ä¸Šä¼ é€»è¾‘
                console.log('æµ‹è¯•å¼€å§‹...');
                
                // è¯»å–æ–‡ä»¶
                const videoData = await readFileAsDataURL(videoFile);
                const markdownContent = await readFileAsText(markdownFile);
                
                console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
                
                // ä¿å­˜æ•°æ®
                const success = saveData(userId, title, videoData, markdownContent);
                
                if (success) {
                    statusDiv.innerHTML = '<div class="status success">âœ“ æµ‹è¯•ä¸Šä¼ æˆåŠŸï¼</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">âœ— æµ‹è¯•ä¸Šä¼ å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('æµ‹è¯•ä¸Šä¼ é”™è¯¯:', error);
                statusDiv.innerHTML = `<div class="status error">âœ— æµ‹è¯•é”™è¯¯: ${error.message}</div>`;
            }
        });

        // IndexedDB é…ç½®å’Œåˆå§‹åŒ–ï¼ˆä½¿ç”¨ä¸ä¸»åº”ç”¨ç›¸åŒçš„æ•°æ®åº“ï¼‰
        let testDB = null;
        const TEST_DB_NAME = 'FileManagerDB';
        const TEST_DB_VERSION = 1;
        const TEST_STORE_NAME = 'files';

        function initTestDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(TEST_DB_NAME, TEST_DB_VERSION);
                
                request.onerror = () => {
                    console.error('æµ‹è¯•æ•°æ®åº“æ‰“å¼€å¤±è´¥:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    testDB = request.result;
                    console.log('æµ‹è¯•æ•°æ®åº“è¿æ¥æˆåŠŸ');
                    resolve(testDB);
                };
                
                request.onupgradeneeded = (event) => {
                    testDB = event.target.result;
                    console.log('æµ‹è¯•æ•°æ®åº“å‡çº§ä¸­...');
                    
                    if (!testDB.objectStoreNames.contains(TEST_STORE_NAME)) {
                        const store = testDB.createObjectStore(TEST_STORE_NAME, { keyPath: 'id' });
                        store.createIndex('userId', 'userId', { unique: false });
                        store.createIndex('title', 'title', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('æµ‹è¯•å¯¹è±¡å­˜å‚¨åˆ›å»ºæˆåŠŸ');
                    }
                };
            });
        }

        // å¤åˆ¶ä¸»åº”ç”¨çš„å‡½æ•°ï¼ˆIndexedDBç‰ˆæœ¬ï¼‰
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                console.log('å¼€å§‹è¯»å–è§†é¢‘æ–‡ä»¶:', file.name, file.type, (file.size / 1024 / 1024).toFixed(2) + ' MB');
                
                if (!file) {
                    reject(new Error('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶'));
                    return;
                }
                
                if (file.size > 50 * 1024 * 1024) { // 50MBé™åˆ¶
                    reject(new Error('è§†é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„æ–‡ä»¶'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = e => {
                    console.log('è§†é¢‘æ–‡ä»¶è¯»å–æˆåŠŸ');
                    resolve(e.target.result);
                };
                reader.onerror = () => {
                    console.error('è§†é¢‘æ–‡ä»¶è¯»å–å¤±è´¥');
                    reject(new Error('è§†é¢‘æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsDataURL(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                console.log('å¼€å§‹è¯»å–Markdownæ–‡ä»¶:', file.name, file.type, (file.size / 1024).toFixed(2) + ' KB');
                
                if (!file) {
                    reject(new Error('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶'));
                    return;
                }
                
                if (file.size > 1024 * 1024) { // 1MBé™åˆ¶
                    reject(new Error('Markdownæ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº1MBçš„æ–‡ä»¶'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = e => {
                    console.log('Markdownæ–‡ä»¶è¯»å–æˆåŠŸ');
                    resolve(e.target.result);
                };
                reader.onerror = () => {
                    console.error('Markdownæ–‡ä»¶è¯»å–å¤±è´¥');
                    reject(new Error('Markdownæ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function saveData(userId, title, videoData, markdownContent) {
            try {
                console.log('å¼€å§‹ä¿å­˜æ•°æ®åˆ°IndexedDB...', { userId, title });
                
                if (!testDB) {
                    throw new Error('æµ‹è¯•æ•°æ®åº“æœªåˆå§‹åŒ–');
                }
                
                // åˆ›å»ºå”¯ä¸€ID
                const id = `${userId}:${title}`;
                
                // å‡†å¤‡æ•°æ®å¯¹è±¡
                const dataObject = {
                    id: id,
                    userId: userId,
                    title: title,
                    video: videoData,
                    markdown: markdownContent,
                    timestamp: new Date().toISOString()
                };
                
                // è®¡ç®—æ•°æ®å¤§å°
                const dataSize = new Blob([JSON.stringify(dataObject)]).size;
                const dataSizeMB = (dataSize / 1024 / 1024).toFixed(2);
                console.log('æ•°æ®å¤§å°:', dataSizeMB + ' MB');
                
                // å¼€å§‹äº‹åŠ¡
                const transaction = testDB.transaction([TEST_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(TEST_STORE_NAME);
                
                return new Promise((resolve, reject) => {
                    const request = store.put(dataObject);
                    
                    request.onsuccess = () => {
                        console.log('æ•°æ®ä¿å­˜æˆåŠŸï¼Œå¤§å°:', dataSizeMB + ' MB');
                        resolve(true);
                    };
                    
                    request.onerror = () => {
                        console.error('æ•°æ®ä¿å­˜å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                    
                    transaction.oncomplete = () => {
                        console.log('äº‹åŠ¡å®Œæˆ');
                    };
                    
                    transaction.onerror = () => {
                        console.error('äº‹åŠ¡å¤±è´¥:', transaction.error);
                        reject(transaction.error);
                    };
                });
                
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ç³»ç»Ÿ
        window.onload = async function() {
            checkSystem();
            testStorage();
            
            // åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
            try {
                await initTestDB();
                console.log('æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
                addLog('ERROR', 'æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        };
    </script>
</body>
</html>
